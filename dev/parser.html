<!DOCTYPE html>
<html>
<head>
<title>Parser: parse data from a csv into a js object</title>
</head>
<body>
<h2>Instructions</h2>
<ol>
  <li />Ensure papaparse.js is in the same folder as this file.
  <li />Copy the comma delimited data into the text area.
  <li />Select the correct option for the data you want to format.
  <li />Click Display formatted data
</ol>

<label><input type="radio" name="output-type" value="0" checked>subrolesByRole</label><br>
<label><input type="radio" name="output-type" value="1">objectivesBySubroleRelevance</label><br>
<label><input type="radio" name="output-type" value="3">objectivesByFundamentalObjective</label><br>
<label><input type="radio" name="output-type" value="2">conceptsByObjective</label><br>
<label><input type="radio" name="output-type" value="4">readIDsByConcept</label><br>
<label><input type="radio" name="output-type" value="5">DPL Links</label><br>
<label><input type="radio" name="output-type" value="6">objectivesBySubrole</label><br>

<textarea id="input" rows="10" style="width:100%" value="Insert text to be converted"></textarea>
<button onclick="compareValues()">Compare CSV with READ's Data</button>
<button onclick="displayFormattedData()">Display formatted data</button>

<h2>Output:</h2>
<button onclick="copyToClipboard('output')">Copy output to clipboard</button>
<div id="output"></div>

<script src="papaparse.js"></script>
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<script src="../js/base.js"></script>
<script>

/** small, composable functions permit flexible reuse */
var getData = function () {
  return document.getElementById('input').value
}

/** requires papaparse.js loaded, E.G. in a script tag */
function parseData(gottenData=getData()){
  var config = { header: true }
  var parsedData = Papa.parse(gottenData, config);
  return parsedData;
}

function formatRelevancyData(data){
  var objectivesBySubrole = [{},{},{}];
  var relevance;
  for (var i=0;i<data.length;i++) {
    if (data[i].Primary === "TRUE") {
      relevance = 0;
    } else if (data[i].Secondary === "TRUE") {
      relevance = 1;
    } else {
      relevance = 2;
    }
    if(!objectivesBySubrole[relevance].hasOwnProperty(data[i].SubRole)) {
      objectivesBySubrole[relevance][data[i].SubRole] = [];  
    }
    objectivesBySubrole[relevance][data[i].SubRole].push(data[i]["Means Objective"]);    
  }
  return objectivesBySubrole;
}

function formatDataConceptsObjectives(data){
  var conceptsByObjective = {};
  for (var i=0;i<data.length;i++) {
    if(!conceptsByObjective.hasOwnProperty(data[i]["Objective"])) {
      conceptsByObjective[data[i]["Objective"]] = [];
    }
    conceptsByObjective[data[i]["Objective"]].push(data[i]["DPSIR Node"]);
    console.log(data[i]["Objective"]);
    console.log(data[i]["DPSIR Node"]);
    if (data[i]["And"] != "") {
      conceptsByObjective[data[i]["Objective"]].push(data[i]["And"]);
      console.log(data[i]["And"]);
    }
  }
  return conceptsByObjective;
}

function formatDataConceptsObjectivesObject(data){
  var conceptsByObjective = {};
  for (var i=0;i<data.length;i++) {
    if(conceptsByObjective[data[i]["Objective"]] !== true) {
      conceptsByObjective[data[i]["Objective"]] = {};
    }
    conceptsByObjective[data[i]["Objective"]][data[i]["DPSIR Node"]] = true;
    if (data[i]["And"] != "") {
      conceptsByObjective[data[i]["Objective"]][data[i]["And"]] = true;
    }
  }
  return conceptsByObjective;
}

function formatData(data, x, y){
  var xByY = {};
  for (var i=0;i<data.length;i++) {
    if(!xByY.hasOwnProperty(data[i][y])) {
      xByY[data[i][y]] = [];  
    }
    xByY[data[i][y]].push(data[i][x]);    
  }
  return xByY;
}

function displayFormattedData() {
  var parsedData = parseData();
  var outputType;
  var radios = document.getElementsByName('output-type');
  for (var i = 0, length = radios.length; i < length; i++) {
    if (radios[i].checked) {
        outputType = radios[i].value;
        break;
    }
  }
  if (outputType == 0){
    var formattedData = formatData(parsedData.data, "SubRole", "Role");
  } else if (outputType == 1){
    var formattedData = formatRelevancyData(parsedData.data);
  } else if (outputType == 2){
    var formattedData = formatDataConceptsObjectives(parsedData.data);
  } else if (outputType == 3) {
    var formattedData = formatData(parsedData.data, "means_objective","fundamental_objective");
  } else if (outputType == 4){
    var formattedData = formatData(parsedData.data, "read_id","node");
  } else if (outputType == 5) {
    var formattedData = formatData(parsedData.data, "name_to","name_from");
  } else if (outputType == 6) {
    var formattedData = formatData(parsedData.data, "Means Objective","SubRole");
  }
  //Returns xByY (ObjectivesBySubrole where x=objective and y=subrole)
  var data = JSON.stringify(formattedData);
  var outputDiv = document.getElementById('output');
  outputDiv.innerText = data;
}

function copyToClipboard(elementId) {
  var hiddenInput = document.createElement("input");
  hiddenInput.setAttribute("value", document.getElementById(elementId).textContent);
  document.body.appendChild(hiddenInput);
  hiddenInput.select();
  document.execCommand("copy");
  document.body.removeChild(hiddenInput);
}

/** return object containing all SHC-tool-details indexed by decision-sector */
var allToolDetails = function () {
  var decisionSectors = ['building infrastructure', 'land use', 'transportation', 'waste management'];
  /* find details in READ web services' docs */
  var resourceAdvancedSearchURL = "https://ofmpub.epa.gov/readwebservices/v1/ResourceAdvancedSearch";
  var resourceDetailURL = "https://ofmpub.epa.gov/readwebservices/v1/ResourceDetail";
  var tools = {};
  for (var j = 0; j < decisionSectors.length; j++) {
    $.get(resourceAdvancedSearchURL, {DecisionSector:decisionSectors[j]}).done(function (data) { $.each(data, function (i) { $.get(resourceDetailURL, {ResourceId:data[i].ResourceId}).done(function (data) {var parsedResult = parseResult(data); tools[parsedResult['Acronym']] = parsedResult;});});});
  }
  return tools;
};

var actualData = allToolDetails();

/**
 * Turn CSV of keywords from text-field into an array of keywords.
 * Useful to ensure all keywords in the spreadsheet appear in READ.
 * The CSV has each tools' keywords on their line.
 */
var keywordsCSVToArray = function() {
  var keywords = [];
  var element = [];
  var keywordsObjectArray = parseData()['data'];
  for (var k = 0; k < keywordsObjectArray.length; k++) {
      element = [];
      element = element.concat(keywordsObjectArray[k]['keywords']);
      if (keywordsObjectArray[k].hasOwnProperty('__parsed_extra')) {
          element = element.concat(keywordsObjectArray[k]['__parsed_extra']);
      }
      keywords = keywords.concat([element]);
  }
  return keywords;
};

/**
 * Compare CSV of values from Excel-workbook for planning
 * tools-inventory-data-entry with values from READ.
 * @parameter {string} fieldnames - specify fields from READ.
 */
var compareValues = function() {
  var parsedData = parseData();
  var intenededData = formatToolData(parsedData.data);
  for (var tool in intenededData) {
    if (intenededData.hasOwnProperty(tool)) {
      if (actualData.hasOwnProperty(tool.substr(0, 15))) {
        console.log('')
        console.log('ID: ' + actualData[tool.substr(0, 15)]['ID']);
        if (intenededData[tool]['Model Inputs'].trim() !== actualData[tool.substr(0, 15)]['Model Inputs'].trim() && actualData[tool.substr(0, 15)]['Model Inputs'] !== 'No Data') {
          console.log('');
          console.log('Model Inputs');
          console.log(intenededData[tool]['Model Inputs']);
          console.log(actualData[tool.substr(0, 15)]['Model Inputs']);
        }
        
        if (intenededData[tool]['Keywords'].replace(/;/g, ',').trim() !== actualData[tool.substr(0, 15)]['Keywords'].trim() && actualData[tool.substr(0, 15)]['Keywords'] !== 'No Data') {
          console.log('');
          console.log('Keywords');
          console.log(intenededData[tool]['Keywords'].replace(/;/g, ','));
          console.log(actualData[tool.substr(0, 15)]['Keywords']);
        }

        if (intenededData[tool]['Acronym'].substr(0, 15).trim() !== actualData[tool.substr(0, 15)]['Acronym'].trim()) {
          console.log('');
          console.log('Acronym');
          console.log(intenededData[tool]['Acronym']);
          console.log(actualData[tool.substr(0, 15)]['Acronym']);
        }

        if (intenededData[tool]['Ownership Type'].trim() !== actualData[tool.substr(0, 15)]['Ownership Type'].trim()) {
          console.log('');
          console.log('Ownership Type');
          console.log(intenededData[tool]['Ownership Type']);
          console.log(actualData[tool.substr(0, 15)]['Ownership Type']);
        }

        if (intenededData[tool]['Open Source'].trim() !== actualData[tool.substr(0, 15)]['Open Source'].trim()) {
          console.log('');
          console.log('Open Source');
          console.log(intenededData[tool]['Open Source']);
          console.log(actualData[tool.substr(0, 15)]['Open Source']);
        }

        if (intenededData[tool]['Ownership Type'].trim() !== actualData[tool.substr(0, 15)]['Ownership Type'].trim()) {
          console.log('');
          console.log('Ownership Type');
          console.log(intenededData[tool]['Ownership Type']);
          console.log(actualData[tool.substr(0, 15)]['Ownership Type']);
        }

        if (intenededData[tool]['Operating Environment'].trim() !== actualData[tool.substr(0, 15)]['Operating Environment'].trim()) {
          console.log('');
          console.log('Operating Environment');
          console.log(intenededData[tool]['Operating Environment']);
          console.log(actualData[tool.substr(0, 15)]['Operating Environment']);
        }

        if (intenededData[tool]['Model Inputs'].trim() !== actualData[tool.substr(0, 15)]['Model Inputs'].trim()) {
          console.log('');
          console.log('Model Inputs');
          console.log(intenededData[tool]['Model Inputs']);
          console.log(actualData[tool.substr(0, 15)]['Model Inputs']);
        }

        if (intenededData[tool]['Output Variables'].trim() !== actualData[tool.substr(0, 15)]['Output Variables'].trim()) {
          console.log('');
          console.log('Output Variables');
          console.log(intenededData[tool]['Output Variables']);
          console.log(actualData[tool.substr(0, 15)]['Output Variables']);
        }

        if (intenededData[tool]['Model Evaluation'].trim() !== actualData[tool.substr(0, 15)]['Model Evaluation'].trim()) {
          console.log('');
          console.log('Model Evaluation');
          console.log(intenededData[tool]['Model Evaluation']);
          console.log(actualData[tool.substr(0, 15)]['Model Evaluation']);
        }

        if (intenededData[tool]['Time Scale'].trim() !== actualData[tool.substr(0, 15)]['Time Scale'].trim()) {
          console.log('');
          console.log('Time Scale');
          console.log(intenededData[tool]['Time Scale']);
          console.log(actualData[tool.substr(0, 15)]['Time Scale']);
        }

        if (intenededData[tool]['Spatial Extent'].trim() !== actualData[tool.substr(0, 15)]['Spatial Extent'].replace(/,/g, ';').replace('and ', '').trim() && actualData[tool.substr(0, 15)]['Spatial Extent'] !== 'No Data') {
          console.log('');
          console.log('Spatial Extent');
          console.log(intenededData[tool]['Spatial Extent']);
          console.log(actualData[tool.substr(0, 15)]['Spatial Extent'].replace(/,/g, ';').replace('and ', ''));
        }

        if (intenededData[tool]['Model Structure'].trim() !== actualData[tool.substr(0, 15)]['Model Structure'].trim()) {
          console.log('');
          console.log('Model Structure');
          console.log(intenededData[tool]['Model Structure']);
          console.log(actualData[tool.substr(0, 15)]['Model Structure']);
        }

        if (intenededData[tool]['Organization'].trim() !== actualData[tool.substr(0, 15)]['Organization'].trim()) {
          console.log('');
          console.log('Organization');
          console.log(intenededData[tool]['Organization']);
          console.log(actualData[tool.substr(0, 15)]['Organization']);
        }
      } else {
        console.log(tool.substr(0, 15) + " is not in inventory.");
      }
    } 
  }
};

function formatToolData(data) {
  var tools = {};
  for (var i = 0; i < data.length; i++) {
    tools[data[i]['Acronym']] = data[i];
  }
  return tools;
}

</script>
</body>
<html>
